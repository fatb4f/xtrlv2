name: schema-ssot-gate

on:
  workflow_dispatch:

jobs:
  ssot-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install .; fi
          pip install pytest

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Preflight required gate artifacts
        run: |
          test -f Justfile
          grep -q '^ssot-pin-check:' Justfile || { echo "Missing Justfile target: ssot-pin-check"; exit 1; }
          test -f tests/test_ssot_pin_check_m2_t01.py || { echo "Missing test file: tests/test_ssot_pin_check_m2_t01.py"; exit 1; }
          test -f tests/test_ssot_conformance.py || { echo "Missing test file: tests/test_ssot_conformance.py"; exit 1; }

      - name: SSOT pin check
        run: just ssot-pin-check

      - name: Conformance gate
        run: pytest -q tests/test_ssot_pin_check_m2_t01.py tests/test_ssot_conformance.py
