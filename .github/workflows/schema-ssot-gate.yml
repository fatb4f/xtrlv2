name: schema-ssot-gate

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  ssot-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install .; fi
          pip install pytest jsonschema

      - name: Install ast-grep
        run: npm install -g @ast-grep/cli

      - name: Preflight required gate artifacts
        run: |
          test -f tests/test_reason_codes_schema.py || { echo "Missing test file: tests/test_reason_codes_schema.py"; exit 1; }
          test -f tests/test_gate_decision_schema.py || { echo "Missing test file: tests/test_gate_decision_schema.py"; exit 1; }
          test -f tests/test_helper_event_schema.py || { echo "Missing test file: tests/test_helper_event_schema.py"; exit 1; }
          test -f tests/test_ledger_latest_schema.py || { echo "Missing test file: tests/test_ledger_latest_schema.py"; exit 1; }
          test -f tests/test_migration_report_schema.py || { echo "Missing test file: tests/test_migration_report_schema.py"; exit 1; }
          test -f tests/test_packet_pre_contract_schema.py || { echo "Missing test file: tests/test_packet_pre_contract_schema.py"; exit 1; }
          test -f tests/test_src_snapshot_schemas.py || { echo "Missing test file: tests/test_src_snapshot_schemas.py"; exit 1; }
          test -f tests/test_schema_examples_validate.py || { echo "Missing test file: tests/test_schema_examples_validate.py"; exit 1; }

      - name: Migration policy gate (ast-grep)
        run: ast-grep scan --config sgconfig.yml

      - name: Migration docs consistency check
        run: python tools/migration/migrate_check.py

      - name: SSOT schema conformance gate
        run: >
          pytest -q
          tests/test_reason_codes_schema.py
          tests/test_gate_decision_schema.py
          tests/test_helper_event_schema.py
          tests/test_ledger_latest_schema.py
          tests/test_migration_report_schema.py
          tests/test_packet_pre_contract_schema.py
          tests/test_src_snapshot_schemas.py
          tests/test_schema_examples_validate.py
